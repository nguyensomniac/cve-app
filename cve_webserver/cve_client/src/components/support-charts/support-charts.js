import React, { Component } from 'react';
import PropTypes from 'prop-types';

const ZingChart = require('zingchart-react').core;
import chroma from 'chroma-js';

// Data and styles
import { ZIP_NAMES, SECTIONS } from '../../const/const';
import styles from './support-charts.css';

class SupportCharts extends Component{

  static propTypes = {
    articles: PropTypes.array,
    activeItem: PropTypes.shape({
      ZIP: PropTypes.number
    }),
    initialZipCounts: PropTypes.object
  }

  constructor(props){
    super(props);

    this.state = {
      query: [],
      data: []
    }
    // query is a list of area codes that Lily would return
    // default is no area code which means show everything
  }

  toMonth(numberString){
    numberString = Number(numberString);
    return numberString;
  }

  articlesByArea(){
    let countMap = {};
    this.props.articles.forEach((item) => {
      if (item["ZIP"] === 'NA') {
        return;
      }
      if(item["ZIP"] in countMap){
        countMap[item["ZIP"]] += 1;
      }
      else{
        countMap[item["ZIP"]] = 1;
      }
    });
    // take the object and convert it to an array, so we can sort it
    let sortedCounts = Object.keys(countMap).map((zip) => {
      return {
        'name': zip,
        'count': countMap[zip]}
    });
    // sort in place, in descending order
    sortedCounts.sort((item1, item2) => {return (item1.count - item2.count)});
    sortedCounts = sortedCounts.filter((item) => (item.count >= 3));
    return sortedCounts;
  }

  articlesBySection(){
    const filteredData = (this.props.activeItem && this.props.activeItem.properties) ?
      this.props.articles.filter((item) => item.ZIP == this.props.activeItem.properties.name) :
      this.props.articles;
    let accumulatedSectionCounts = {};
    SECTIONS.map((s) => {
      accumulatedSectionCounts[s] = [0, 0, 0, 0];
    })
    // "94704":[12, 23, 23, 24]
    filteredData.forEach((item)=>{
      let sectionCounts = {};
      item.Sections.map((section) => {
        SECTIONS.map((s) => {
          if (section.toUpperCase().indexOf(s.toUpperCase()) !== -1) {
            sectionCounts[s] = 1;
          }
        })
      })
      Object.keys(sectionCounts).map((sectionName) => {
        const month = this.toMonth(item.Date.slice(5,7))
        accumulatedSectionCounts[sectionName][month - 1] += 1;
      })
    });
    return accumulatedSectionCounts;
  }

  renderBarChartIfNeeded() {
    if (this.props.activeItem && this.props.activeItem.properties) { return; }
    const articlesCount = this.articlesByArea(this.props.articles);
    const areaCodeLabels = articlesCount.map((item) => item.name);
    const areaCodeValues = articlesCount.map((item) => item.count);
    const maxCount = Math.max.apply(null, areaCodeValues);
    const areaCodeText = articlesCount.map((item, i) => {
      return {
        text: (i == articlesCount.length - 1) ? `${item.count} articles` : item.count,
        hook: `node:plot=1,index=${i}`,
        color: (i == articlesCount.length - 1) ? 'white' : '#444444',
        offsetX: (i == articlesCount.length - 1) ? -35 : 8,
        textAlign: 'left'
      }
    });
    const barConfig = {
      "scale-x": {
        labels: areaCodeLabels,
        'items-overlap': true,
        tick: {
          visible: false
        }
      },
      "scale-y": {
        guide: {
          visible: false
        }
      },
      "plot": {
        "bar-width": "20px",
        "bar-space": "8px",
        stacked: true,
        tooltip: {
          visible: false
        }
      },
      labels: areaCodeText,
      plotarea: {
        margin: '0 dynamic'
      },
      type: "hbar",
      series : [
        {
          values : areaCodeValues,
          backgroundColor: '#628FFF'
        },
        { values : areaCodeValues.map(() => 0)}
      ]
    };
    return (
      <div className={styles.chartContainer}>
        <div className={styles.chartTitle}>Total articles published, by ZIP code</div>
        <ZingChart id="barChart" height="400px" width="100%" data={barConfig} />
      </div>
    )
  }

  renderLineChart = () => {
    const articlesListBySection = this.articlesBySection(this.props.articles);
    const areaCodeLabels = Object.keys(articlesListBySection);
    let monthValues = [];
    // set up color scale
    const colorScale = chroma.scale(['#2749FF', '#FFD386']).mode('lch').colors(areaCodeLabels.length)
    areaCodeLabels.map((item, i) => {
      monthValues.push({
        values: articlesListBySection[item],
        text: item,
        lineColor: colorScale[i],
        marker: {
          backgroundColor: colorScale[i]
        }
      });
    })
    let lineConfig = {
      "scale-x": {
        labels: ["Jan", "Feb", "March", "April"],
        tick: {
          visible: false
        }
      },
      'scale-y': {
        guide: {
          visible: false
        },
        tick: {
          visible: false
        }
      },
      plotarea: {
        margin: 'dynamic'
      },
      legend: {
        marker: {
          borderRadius: '100%',
          margin: 0
        },
        item: {
          margin: 0,
        },
        layout: 'float',
        adjustLayout: true,
        align: 'right',
        borderWidth: 0
      },
      type: "line",
      series : monthValues
    };
    const title = (this.props.activeItem && this.props.activeItem.properties) ?
      `Articles published in ${this.props.activeItem.properties.name} by category`:
      'Articles published by category';
    return (
      <div className={styles.chartContainer}>
        <div className={styles.chartTitle}>{title}</div>
        <ZingChart id="lineChart" height="250" width="100%" data={lineConfig} />
      </div>
    )
  }

  renderMonthlyCoverage() {
    if (!this.props.activeItem || !this.props.activeItem.properties) { return; }
    const activeZip = this.props.activeItem.properties.name;
    const population = this.props.activeItem.properties.population;
    const numArticles = this.props.initialZipCounts[activeZip];
    return (
      <div>
        <h4>Coverage this month</h4>
        <div className={styles.figureRow}>
          <div className={styles.figureContainer}>
            <div className={styles.figure}>{numArticles}</div>
            <div className={styles.figureLabel}>articles</div>
          </div>
          <div className={styles.figureContainer}>
            <div className={styles.figure}>{Math.round(numArticles / population * 100000)}</div>
            <div className={styles.figureLabel}>articles per 100K residents</div>
          </div>
        </div>
      </div>
    )
  }

  renderNeighborhoodNameIfNeeded() {
    if (!this.props.activeItem || !this.props.activeItem.properties) { return; }
    const zip = this.props.activeItem.properties.name;
    return (
      <h3 className={styles.neighborhoodName}>
        {`${zip}: ${ZIP_NAMES[zip]}`}
      </h3>
    )
  }

  renderDemographics() {
    if (!this.props.activeItem || !this.props.activeItem.properties) { return; }
    const population = this.props.activeItem.properties.population;
    const income = this.props.activeItem.properties.income;
    const races = [
      {name: 'American Indian', value: this.props.activeItem.properties.am_indian},
      {name: 'Asian', value: this.props.activeItem.properties.asian},
      {name: 'Black', value: this.props.activeItem.properties.black},
      {name: 'Hispanic', value: this.props.activeItem.properties.hispanic},
      {name: 'Mixed', value: this.props.activeItem.properties.mixed_race},
      {name: 'Pacific Islander', value: this.props.activeItem.properties.pacific_islander},
      {name: 'Other', value: this.props.activeItem.properties.other},
      {name: 'White', value: this.props.activeItem.properties.white},
    ]
    const significantRaces = races.filter((race) => race.value >= 0.2 * population)
      .sort((a, b) => b.value - a.value)
      .map((item) => item.name);

    return (
      <div>
        <h4>Demographics</h4>
        <div className={styles.figureRow}>
          <div className={styles.figureContainer}>
            <div className={styles.figure}>{population}</div>
            <div className={styles.figureLabel}>population</div>
          </div>
          <div className={styles.figureContainer}>
            <div className={styles.figure}>{income}</div>
            <div className={styles.figureLabel}>median household income</div>
          </div>
          <div className={styles.figureContainer}>
            <div className={styles.figure}>{significantRaces.join(', ')}</div>
            <div className={styles.figureLabel}>common ethnic groups</div>
          </div>
        </div>
      </div>
    )
  }

  render(){
    return(
      <div>
        {this.renderNeighborhoodNameIfNeeded()}
        {this.renderMonthlyCoverage()}
        {this.renderBarChartIfNeeded()}
        {this.renderLineChart()}
        {this.renderDemographics()}
      </div>
    );
  }
}

export default SupportCharts;



    // TODO:
    // retrieve default state to all so that a chart is visible - DONE
    // retrieve data for this default state - DONE
    // define labels + summarizing information at the top of the chart
    // Implement bar graphs for total number of articles so far
    // Implement line graphs for number of articles per pin code over time

    // TODO Manipulations:
    // Summative coverage across all areas by number of articles (bar graph)
    // Month-by-month coverage across all areas by number of articles (line graph)
    // Tool-tip at each data point showing the population of that area and the tag that is covered the most

    // On selection from Lily's map
      // Show population of area(s) - comparative bar graph representation
      // Show population breakdown (use census data)
      // Month by month coverage across those areas (line graph)
      // Month by month coverage for ONE area by categories covered
